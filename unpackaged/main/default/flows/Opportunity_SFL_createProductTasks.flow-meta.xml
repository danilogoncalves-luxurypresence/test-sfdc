<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <name>Transform_Options_to_Collection_of_Options</name>
        <label>Transform Options to Collection of Options</label>
        <locationX>490</locationX>
        <locationY>758</locationY>
        <actionName>ConvertCSVToStringCollection_CP</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>Loop_through_options</targetReference>
        </connector>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>csvString</name>
            <value>
                <elementReference>Loop_through_products.Option_Selected__c</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>delimiter</name>
            <value>
                <stringValue>;</stringValue>
            </value>
        </inputParameters>
        <nameSegment>ConvertCSVToStringCollection_CP</nameSegment>
        <offset>0</offset>
        <outputParameters>
            <assignToReference>varOptionSelected</assignToReference>
            <name>stringCollection</name>
        </outputParameters>
        <versionSegment>1</versionSegment>
    </actionCalls>
    <apiVersion>61.0</apiVersion>
    <assignments>
        <name>Assign_Opportunity_Id</name>
        <label>Assign Opportunity Id</label>
        <locationX>314</locationX>
        <locationY>242</locationY>
        <assignmentItems>
            <assignToReference>vOpportunityId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>vOpportunityRecord.Id</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Get_Products_That_Need_Implementation_Task</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_Opportunity_Record_to_Variable</name>
        <label>Assign Opportunity Record to Variable</label>
        <locationX>50</locationX>
        <locationY>350</locationY>
        <assignmentItems>
            <assignToReference>vOpportunityRecord</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_Opportunity</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Get_Products_That_Need_Implementation_Task</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Task_setup</name>
        <label>Task setup</label>
        <locationX>578</locationX>
        <locationY>974</locationY>
        <assignmentItems>
            <assignToReference>vTaskToBeCreated.Subject</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>fSubject</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>vTaskToBeCreated.ActivityDate</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>fTaskDueDate</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>vTaskToBeCreated.WhatId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>vOpportunityRecord.AccountId</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>vTaskToBeCreated.RecordTypeId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Label.ID_Task_General_Task</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>vTaskToBeCreated.OwnerId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>fTaskOwner</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>vListOfTasks</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>vTaskToBeCreated</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_through_options</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Flow_started_with_Id_or_Record</name>
        <label>Flow started with Id or Record</label>
        <locationX>314</locationX>
        <locationY>134</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Started_with_Id</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>vOpportunityId</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>vOpportunityRecord</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Opportunity</targetReference>
            </connector>
            <label>Started with Id</label>
        </rules>
        <rules>
            <name>Started_with_Record</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>vOpportunityRecord</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>vOpportunityId</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_Opportunity_Id</targetReference>
            </connector>
            <label>Started with Record</label>
        </rules>
    </decisions>
    <description>Receives opportunity Id and creates product task for each found product</description>
    <environments>Default</environments>
    <formulas>
        <name>fSubject</name>
        <dataType>String</dataType>
        <expression>{!vOpportunityRecord.Name} &amp; &quot; - &quot; &amp; {!Loop_through_products.Product_Name__c} &amp; &quot; - &quot; &amp; {!Loop_through_options}</expression>
    </formulas>
    <formulas>
        <name>fTaskDueDate</name>
        <dataType>Date</dataType>
        <expression>TODAY()+1</expression>
    </formulas>
    <formulas>
        <name>fTaskOwner</name>
        <dataType>String</dataType>
        <expression>IF({!vOpportunityRecord.Record_Type_Name__c} = &#39;New Sales&#39;,
IF(ISBLANK({!vOpportunityRecord.Account.Implementation_Manager__c}),{!vOpportunityRecord.Account.OwnerId},{!vOpportunityRecord.Account.Implementation_Manager__c}),
IF(ISBLANK({!vOpportunityRecord.Account.Account_Manager__c}),{!vOpportunityRecord.Account.OwnerId},{!vOpportunityRecord.Account.Account_Manager__c}))</expression>
    </formulas>
    <interviewLabel>subfl {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Opportunity_SFL_createProductTasks</label>
    <loops>
        <name>Loop_through_options</name>
        <label>Loop through options</label>
        <locationX>490</locationX>
        <locationY>866</locationY>
        <collectionReference>varOptionSelected</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Task_setup</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Loop_through_products</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>Loop_through_products</name>
        <label>Loop through products</label>
        <locationX>314</locationX>
        <locationY>650</locationY>
        <collectionReference>Get_Products_That_Need_Implementation_Task</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Transform_Options_to_Collection_of_Options</targetReference>
        </nextValueConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <name>Get_Opportunity</name>
        <label>Get Opportunity</label>
        <locationX>50</locationX>
        <locationY>242</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Assign_Opportunity_Record_to_Variable</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>vOpportunityId</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Opportunity</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Products_That_Need_Implementation_Task</name>
        <label>Get Products That Need Implementation Task</label>
        <locationX>314</locationX>
        <locationY>542</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Loop_through_products</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>OpportunityId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>vOpportunityId</elementReference>
            </value>
        </filters>
        <filters>
            <field>Option_Selected__c</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>OpportunityLineItem</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <start>
        <locationX>188</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Flow_started_with_Id_or_Record</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <variables>
        <name>varOptionSelected</name>
        <dataType>String</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vListOfTasks</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
        <objectType>Task</objectType>
    </variables>
    <variables>
        <name>vOpportunityId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>vOpportunityRecord</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <objectType>Opportunity</objectType>
    </variables>
    <variables>
        <name>vTaskToBeCreated</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Task</objectType>
    </variables>
</Flow>
